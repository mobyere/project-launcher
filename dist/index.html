<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Launcher</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Project Launcher</h1>
            <div class="header-actions">
                <button id="stopAllBtn" class="btn btn-warning">⏹ Stop All</button>
                <button id="settingsBtn" class="btn btn-icon" title="Settings">⚙️</button>
                <button id="addProjectBtn" class="btn btn-primary">+ Add Project</button>
            </div>
        </header>

        <div id="projectsList" class="projects-list">
            <!-- Projects will be dynamically added here -->
        </div>

        <!-- Modal for adding projects -->
        <div id="addProjectModal" class="modal hidden">
            <div class="modal-content">
                <h2 id="modalTitle">Add New Project</h2>
                <form id="addProjectForm">
                    <input type="hidden" id="editIndex" value="">
                    <div class="form-group">
                        <label for="projectName">Project Name</label>
                        <input type="text" id="projectName" required>
                    </div>
                    <div class="form-group">
                        <label for="projectType">Project Type</label>
                        <select id="projectType" required>
                            <option value="">Select Type</option>
                            <option value="java-gradle">Java (Gradle)</option>
                            <option value="angular">Angular</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="projectPath">Project Path</label>
                        <div class="path-input">
                            <input type="text" id="projectPath" required>
                            <button type="button" id="browseBtn" class="btn btn-secondary">Browse</button>
                        </div>
                    </div>
                    <div class="form-group" id="commandGroup">
                        <label for="startCommand">
                            Start Command
                            <span id="commandTooltip" class="tooltip hidden" title="exemple: ./gradlew clean bootJar && java -jar gateway/build/libs/pro-shell.jar --spring.profiles.active=local">ℹ️</span>
                        </label>
                        <input type="text" id="startCommand" placeholder="e.g., mvn spring-boot:run">
                    </div>
                    <div class="form-actions">
                        <button type="button" id="cancelBtn" class="btn btn-secondary">Cancel</button>
                        <button type="submit" id="submitBtn" class="btn btn-primary">Add Project</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Confirmation modal for deleting projects -->
        <div id="deleteConfirmModal" class="modal hidden">
            <div class="modal-content">
                <h2>Delete Project</h2>
                <p id="deleteConfirmMessage">Are you sure you want to delete this project?</p>
                <div class="form-actions">
                    <button type="button" id="cancelDeleteBtn" class="btn btn-secondary">Cancel</button>
                    <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
                </div>
            </div>
        </div>

        <!-- Settings modal -->
        <div id="settingsModal" class="modal hidden">
            <div class="modal-content">
                <h2>Settings</h2>
                <div class="settings-section">
                    <h3>Data Management</h3>
                    <p class="settings-description">Reset all project data and clear saved configurations.</p>
                    <button type="button" id="resetDataBtn" class="btn btn-danger">Reset All Data</button>
                </div>
                <div class="form-actions">
                    <button type="button" id="closeSettingsBtn" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>

        <!-- Reset confirmation modal -->
        <div id="resetConfirmModal" class="modal hidden">
            <div class="modal-content">
                <h2>⚠️ Reset All Data</h2>
                <p>This will permanently delete all your projects and configurations. This action cannot be undone.</p>
                <p><strong>Are you sure you want to continue?</strong></p>
                <div class="form-actions">
                    <button type="button" id="cancelResetBtn" class="btn btn-secondary">Cancel</button>
                    <button type="button" id="confirmResetBtn" class="btn btn-danger">Yes, Reset All Data</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        let projects = [];
        let invoke, open;
        let deleteIndex = null; // Store the index of project to delete
        let packageManagers = {}; // Store detected package managers for each project

        // Wait for DOM to be ready
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded fired');
            console.log('window.__TAURI__:', window.__TAURI__);

            // Wait for Tauri to be available
            if (window.__TAURI__) {
                invoke = window.__TAURI__.core.invoke;
                open = window.__TAURI__.dialog.open;
            } else {
                console.error('Tauri API not available!');
                alert('Error: Tauri API not loaded');
                return;
            }

            // Initialize DOM Elements
            const addProjectBtn = document.getElementById('addProjectBtn');
            const addProjectModal = document.getElementById('addProjectModal');
            const addProjectForm = document.getElementById('addProjectForm');
            const cancelBtn = document.getElementById('cancelBtn');
            const projectsList = document.getElementById('projectsList');
            const browseBtn = document.getElementById('browseBtn');
            const projectTypeSelect = document.getElementById('projectType');
            const startCommandInput = document.getElementById('startCommand');
            const deleteConfirmModal = document.getElementById('deleteConfirmModal');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const stopAllBtn = document.getElementById('stopAllBtn');
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            const resetDataBtn = document.getElementById('resetDataBtn');
            const resetConfirmModal = document.getElementById('resetConfirmModal');
            const cancelResetBtn = document.getElementById('cancelResetBtn');
            const confirmResetBtn = document.getElementById('confirmResetBtn');

            // Show/hide modal
            addProjectBtn.addEventListener('click', () => {
                console.log('Add Project button clicked!');
                document.getElementById('modalTitle').textContent = 'Add New Project';
                document.getElementById('submitBtn').textContent = 'Add Project';
                document.getElementById('editIndex').value = '';
                addProjectForm.reset();
                addProjectModal.classList.remove('hidden');
            });

            cancelBtn.addEventListener('click', () => {
                addProjectModal.classList.add('hidden');
                addProjectForm.reset();
                document.getElementById('editIndex').value = '';
            });

            // Delete confirmation modal handlers
            cancelDeleteBtn.addEventListener('click', () => {
                deleteConfirmModal.classList.add('hidden');
                deleteIndex = null;
            });

            confirmDeleteBtn.addEventListener('click', async () => {
                if (deleteIndex !== null) {
                    await performDelete(deleteIndex);
                    deleteConfirmModal.classList.add('hidden');
                    deleteIndex = null;
                }
            });

            // Stop all projects handler
            stopAllBtn.addEventListener('click', async () => {
                await stopAllProjects();
            });

            // Settings modal handlers
            settingsBtn.addEventListener('click', () => {
                settingsModal.classList.remove('hidden');
            });

            closeSettingsBtn.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });

            // Reset data handlers
            resetDataBtn.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
                resetConfirmModal.classList.remove('hidden');
            });

            cancelResetBtn.addEventListener('click', () => {
                resetConfirmModal.classList.add('hidden');
            });

            confirmResetBtn.addEventListener('click', async () => {
                await resetAllData();
                resetConfirmModal.classList.add('hidden');
            });

            // Browse for directory
            browseBtn.addEventListener('click', async () => {
                try {
                    const selected = await open({
                        directory: true,
                        multiple: false,
                    });

                    if (selected) {
                        document.getElementById('projectPath').value = selected;
                    }
                } catch (error) {
                    console.error('Error selecting directory:', error);
                }
            });

            // Update start command placeholder based on project type
            projectTypeSelect.addEventListener('change', (e) => {
                const type = e.target.value;
                const tooltip = document.getElementById('commandTooltip');

                if (type === 'java-gradle') {
                    startCommandInput.placeholder = 'e.g., ./gradlew clean bootRun';
                    startCommandInput.value = startCommandInput.value || './gradlew clean bootRun';
                    tooltip.classList.remove('hidden');
                } else if (type === 'angular') {
                    startCommandInput.placeholder = 'e.g., npm run udev:shell';
                    startCommandInput.value = startCommandInput.value || 'npm run start';
                    tooltip.classList.add('hidden');
                } else {
                    tooltip.classList.add('hidden');
                }
            });

            // Add or edit project
            addProjectForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const editIndex = document.getElementById('editIndex').value;
                const projectData = {
                    name: document.getElementById('projectName').value,
                    type: document.getElementById('projectType').value,
                    path: document.getElementById('projectPath').value,
                    command: document.getElementById('startCommand').value,
                    running: false,
                    output: ''
                };

                if (editIndex !== '') {
                    // Edit existing project
                    const index = parseInt(editIndex);
                    projects[index] = {
                        ...projects[index],
                        ...projectData
                    };
                } else {
                    // Add new project
                    projects.push(projectData);
                }

                await saveProjects();
                await detectAllPackageManagers();
                renderProjects();

                addProjectModal.classList.add('hidden');
                addProjectForm.reset();
                document.getElementById('editIndex').value = '';
            });

            // Load initial data
            await loadProjects();
            await detectAllPackageManagers();
            renderProjects();
        });

        // Detect package managers for all Angular projects
        async function detectAllPackageManagers() {
            for (let i = 0; i < projects.length; i++) {
                const project = projects[i];
                if (project.type === 'angular' && project.path) {
                    try {
                        const pm = await invoke('detect_package_manager', { path: project.path });
                        packageManagers[i] = pm;
                    } catch (error) {
                        console.error('Error detecting package manager for project', i, error);
                        packageManagers[i] = 'npm'; // default to npm
                    }
                }
            }
        }

        // Load projects from storage
        async function loadProjects() {
            try {
                const stored = await invoke('get_projects');

                // If no projects exist, initialize with default projects
                if (!stored || stored.length === 0) {
                    projects = [
                        {
                            name: 'pro-shell-ng',
                            type: 'angular',
                            path: '',
                            command: 'npm run udev:shell',
                            running: false,
                            output: ''
                        },
                        {
                            name: 'pro-shell-gw',
                            type: 'java-gradle',
                            path: '',
                            command: './gradlew clean bootJar && java -jar gateway/build/libs/pro-shell.jar --spring.profiles.active=local',
                            running: false,
                            output: ''
                        },
                        {
                            name: 'pro-shell-ng aft',
                            type: 'angular',
                            path: '',
                            command: 'npx ng run shell:serve-aft',
                            running: false,
                            output: ''
                        },
                        {
                            name: 'pro-shell-gw AFT',
                            type: 'java-gradle',
                            path: '',
                            command: './gradlew clean bootJar && java -jar gateway/build/libs/pro-shell.jar --spring.profiles.active=aft',
                            running: false,
                            output: ''
                        },
                        {
                            name: 'ape-mfe-ng',
                            type: 'angular',
                            path: '',
                            command: 'npm run start',
                            running: false,
                            output: ''
                        }
                    ];
                    await saveProjects();
                } else {
                    projects = stored.map(project => ({
                        ...project,
                        running: false,  // Always start with all projects stopped
                        output: ''       // Clear previous output
                    }));
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                projects = [];
            }
        }

        // Save projects to storage
        async function saveProjects() {
            try {
                await invoke('save_projects', { projects });
            } catch (error) {
                console.error('Error saving projects:', error);
            }
        }

        // Render projects list
        function renderProjects() {
            if (projects.length === 0) {
                projectsList.innerHTML = `
                    <div class="empty-state">
                        <h2>No Projects Yet</h2>
                        <p>Click "Add Project" to get started</p>
                    </div>
                `;
                return;
            }

            projectsList.innerHTML = projects.map((project, index) => {
                const isInvalid = !project.path || !project.command;
                const missingFields = [];
                if (!project.path) missingFields.push('path');
                if (!project.command) missingFields.push('command');
                const isAngular = project.type === 'angular';
                const packageManager = packageManagers[index] || 'npm';

                return `
                <div class="project-card" data-index="${index}">
                    <div class="project-header">
                        <div class="project-info">
                            <h3>${project.name}</h3>
                            <span class="project-type ${project.type}">${project.type}</span>
                            ${isAngular && project.path ? `<span class="package-manager-badge">${packageManager}</span>` : ''}
                        </div>
                        <button class="delete-btn" onclick="deleteProject(${index})">×</button>
                    </div>
                    <div class="project-path">${project.path || '<em>No path set</em>'}</div>
                    ${isInvalid && !project.running ? `
                        <div class="invalid-warning">
                            <span class="invalid-warning-icon">⚠️</span>
                            <span>Cannot start: Missing ${missingFields.join(' and ')}</span>
                        </div>
                    ` : ''}
                    <div class="project-status">
                        <span class="status-indicator ${project.running ? 'running' : (isInvalid ? 'invalid' : 'stopped')}"></span>
                        <span>${project.running ? 'Running' : (isInvalid ? 'Invalid' : 'Stopped')}</span>
                    </div>
                    <div class="project-actions">
                        ${project.running
                            ? `<button class="btn btn-danger" onclick="stopProject(${index})">Stop</button>`
                            : `<button class="btn btn-success" onclick="startProject(${index})" ${isInvalid ? 'disabled' : ''}>Start</button>`
                        }
                        ${isAngular && project.path && !project.running ? `<button class="btn btn-install" onclick="installPackages(${index})">📦 Install</button>` : ''}
                        <button class="btn btn-secondary" onclick="editProject(${index})">Edit</button>
                    </div>
                    ${project.output ? `
                        <div class="output-section">
                            <div class="output-header">
                                <span>Output:</span>
                                <button class="clear-output" onclick="clearOutput(${index})">Clear</button>
                            </div>
                            <pre>${project.output}</pre>
                        </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }

        // Start project
        window.startProject = async (index) => {
            const project = projects[index];

            try {
                await invoke('start_project', {
                    path: project.path,
                    command: project.command,
                    index: index
                });

                project.running = true;
                project.output = 'Starting project...\n';
                renderProjects();
                await saveProjects();

                // Start listening for output
                listenToOutput(index);
            } catch (error) {
                console.error('Error starting project:', error);
                project.output = `Error: ${error}\n`;
                renderProjects();
            }
        };

        // Stop project
        window.stopProject = async (index) => {
            const project = projects[index];

            try {
                await invoke('stop_project', { index: index });
                project.running = false;
                project.output += '\nProject stopped.\n';
                renderProjects();
                await saveProjects();
            } catch (error) {
                console.error('Error stopping project:', error);
                project.output += `\nError stopping: ${error}\n`;
                renderProjects();
            }
        };

        // Edit project
        window.editProject = (index) => {
            const project = projects[index];

            // Populate form with project data
            document.getElementById('modalTitle').textContent = 'Edit Project';
            document.getElementById('submitBtn').textContent = 'Edit Project';
            document.getElementById('editIndex').value = index;
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectType').value = project.type;
            document.getElementById('projectPath').value = project.path;
            document.getElementById('startCommand').value = project.command;

            // Show/hide tooltip based on project type
            const tooltip = document.getElementById('commandTooltip');
            if (project.type === 'java-gradle') {
                tooltip.classList.remove('hidden');
            } else {
                tooltip.classList.add('hidden');
            }

            // Show modal
            document.getElementById('addProjectModal').classList.remove('hidden');
        };

        // Show delete confirmation modal
        window.deleteProject = (index) => {
            const project = projects[index];
            deleteIndex = index;

            // Update confirmation message with project name
            document.getElementById('deleteConfirmMessage').textContent =
                `Are you sure you want to delete "${project.name}"?`;

            document.getElementById('deleteConfirmModal').classList.remove('hidden');
        };

        // Perform actual deletion
        async function performDelete(index) {
            if (projects[index].running) {
                await window.stopProject(index);
            }

            projects.splice(index, 1);
            await saveProjects();
            renderProjects();
        }

        // Clear output
        window.clearOutput = async (index) => {
            projects[index].output = '';
            renderProjects();
            await saveProjects();
        };

        // Install packages
        window.installPackages = async (index) => {
            const project = projects[index];
            const packageManager = packageManagers[index] || 'npm';

            if (!project.path) {
                alert('Project path is not set');
                return;
            }

            try {
                project.running = true;
                project.output = `Installing packages using ${packageManager}...\n`;
                renderProjects();

                await invoke('install_packages', {
                    path: project.path,
                    packageManager: packageManager,
                    index: index
                });

                // Start listening for output
                listenToOutput(index);
            } catch (error) {
                console.error('Error installing packages:', error);
                project.output = `Error: ${error}\n`;
                project.running = false;
                renderProjects();
            }
        };

        // Listen to project output
        async function listenToOutput(index) {
            const interval = setInterval(async () => {
                if (!projects[index].running) {
                    clearInterval(interval);
                    return;
                }

                try {
                    const output = await invoke('get_project_output', { index: index });
                    if (output !== projects[index].output) {
                        projects[index].output = output;
                        renderProjects();
                    }
                } catch (error) {
                    console.error('Error getting output:', error);
                }
            }, 1000);
        }

        // Stop all running projects
        async function stopAllProjects() {
            try {
                let stoppedCount = 0;

                for (let i = 0; i < projects.length; i++) {
                    if (projects[i].running) {
                        await window.stopProject(i);
                        stoppedCount++;
                    }
                }

                if (stoppedCount === 0) {
                    console.log('No running projects to stop');
                } else {
                    console.log(`Stopped ${stoppedCount} project(s)`);
                }
            } catch (error) {
                console.error('Error stopping all projects:', error);
                alert('Error stopping projects: ' + error);
            }
        }

        // Reset all data
        async function resetAllData() {
            try {
                // Stop all running projects
                for (let i = 0; i < projects.length; i++) {
                    if (projects[i].running) {
                        await invoke('stop_project', { index: i });
                    }
                }

                // Clear projects array
                projects = [];

                // Save empty projects list
                await saveProjects();

                // Re-render
                renderProjects();

                console.log('All data has been reset');
            } catch (error) {
                console.error('Error resetting data:', error);
                alert('Error resetting data: ' + error);
            }
        }
    </script>
</body>
</html>
